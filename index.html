<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Inventory Management</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Load html2pdf.js for Direct PDF Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Font for Khmer Language -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        /* Animation utilities */
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Scrollbar for dropdown */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
    </style>
    
    <!-- Import Map for cleaner imports -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.378.0"
        }
    }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        
        // Firebase Imports from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            set, 
            onValue, 
            remove, 
            update 
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Icons
        import { 
            LayoutDashboard, 
            PackagePlus, 
            PackageMinus, 
            ClipboardList, 
            Search, 
            AlertTriangle, 
            Edit, 
            Trash2, 
            Computer, 
            X, 
            Save, 
            Check, 
            Database, 
            History, 
            Calendar,
            UserX,
            UserCheck,
            User,
            CreditCard, 
            Briefcase,
            Users,
            FileSpreadsheet,
            Printer,
            FileText,
            Download
        } from 'lucide-react';

        // --- 1. Inventory Realtime Database Configuration ---
        const inventoryConfig = {
            apiKey: "AIzaSyACtQoZQ_LOe3ijNZAWt-hcb2BF3cDBiLk",
            authDomain: "managermenpcdi.firebaseapp.com",
            databaseURL: "https://managermenpcdi-default-rtdb.firebaseio.com",
            projectId: "managermenpcdi",
            storageBucket: "managermenpcdi.firebasestorage.app",
            messagingSenderId: "740667442678",
            appId: "1:740667442678:web:ac672dd9ebfeaf439e33d7",
            measurementId: "G-G818R0HG3Q"
        };

        // --- 2. User List Realtime Database Configuration (New) ---
        const userListConfig = {
            apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s",
            authDomain: "dilistname.firebaseapp.com",
            databaseURL: "https://dilistname-default-rtdb.firebaseio.com",
            projectId: "dilistname",
            storageBucket: "dilistname.firebasestorage.app",
            messagingSenderId: "897983357871",
            appId: "1:897983357871:web:42a046bc9fb3e0543dc55a",
            measurementId: "G-NQ798D9J6K"
        };

        // Initialize Firebase Apps
        const app = initializeApp(inventoryConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const userApp = initializeApp(userListConfig, "userApp"); 
        const userDb = getDatabase(userApp);
        const userAuth = getAuth(userApp); 
        
        // --- CONSTANTS ---
        const CABINET_OPTIONS = Array.from({ length: 12 }, (_, i) => ({
            label: `ទូទី${i + 1}`,
            value: `Cabinet ${i + 1}`
        }));


        // --- Helper Components ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const base = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
                danger: "bg-red-100 text-red-600 hover:bg-red-200",
                success: "bg-green-600 text-white hover:bg-green-700",
                purple: "bg-purple-600 text-white hover:bg-purple-700"
            };
            return (
                <button 
                type={type} 
                onClick={onClick} 
                disabled={disabled}
                className={`${base} ${variants[variant]} ${className}`}
                >
                {children}
                </button>
            );
        };

        const Input = ({ label, value, onChange, type = "text", placeholder, required = false, disabled = false }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input
                type={type}
                value={value}
                onChange={onChange}
                required={required}
                disabled={disabled}
                placeholder={placeholder}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors disabled:bg-gray-100"
                />
            </div>
        );

        const Select = ({ label, value, onChange, options, required = false }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <select
                value={value}
                onChange={onChange}
                required={required}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white"
                >
                <option value="">-- សូមជ្រើសរើស --</option>
                {options.map((opt, idx) => (
                    <option key={idx} value={opt.value}>{opt.label}</option>
                ))}
                </select>
            </div>
        );

        // --- Main App Component ---
        function ComputerInventoryApp() {
            const [user, setUser] = useState(null);
            const [authStatus, setAuthStatus] = useState('checking');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [items, setItems] = useState([]);
            const [requests, setRequests] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);

            // Authentication Setup (Primary)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                        setAuthStatus('authenticated');
                    } catch (error) {
                        console.warn("Inventory Auth: Disabled/Not Configured. Using Public Mode.");
                        setAuthStatus('public');
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setAuthStatus('authenticated');
                    }
                });
                return () => unsubscribe();
            }, []);

            // Realtime Database Listeners (Inventory)
            useEffect(() => {
                const itemsRef = ref(db, 'inventory_items');
                const unsubItems = onValue(itemsRef, (snapshot) => {
                    const data = snapshot.val();
                    const loadedItems = [];
                    if (data) {
                        for (const key in data) {
                            loadedItems.push({ id: key, ...data[key] });
                        }
                    }
                    setItems(loadedItems);
                    setLoading(false);
                }, (error) => {
                    console.error("DB Error:", error);
                    showNotification("បញ្ហាតភ្ជាប់ Database ស្តុក", "error");
                    setLoading(false);
                });

                const reqRef = ref(db, 'inventory_requests');
                const unsubReq = onValue(reqRef, (snapshot) => {
                    const data = snapshot.val();
                    const loadedReqs = [];
                    if (data) {
                        for (const key in data) {
                            loadedReqs.push({ id: key, ...data[key] });
                        }
                    }
                    loadedReqs.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setRequests(loadedReqs);
                });

                return () => {
                    unsubItems();
                    unsubReq();
                };
            }, []);

            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // --- Actions ---
            const handleAddItem = async (e, formData, resetForm) => {
                e.preventDefault();
                try {
                const newItemRef = push(ref(db, 'inventory_items'));
                await set(newItemRef, {
                    ...formData,
                    quantity: parseInt(formData.quantity),
                    lastUpdated: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                });
                showNotification('បានបញ្ចូលសម្ភារៈថ្មីដោយជោគជ័យ!', 'success');
                resetForm();
                } catch (error) {
                console.error(error);
                showNotification('បរាជ័យក្នុងការបញ្ចូលទិន្នន័យ', 'error');
                }
            };

            const handleStockOut = async (e, formData, resetForm) => {
                e.preventDefault();
                const item = items.find(i => i.id === formData.itemId);
                if (!item) return;

                const qty = parseInt(formData.quantity);
                if (item.quantity < qty) {
                showNotification('ចំនួនក្នុងស្តុកមិនគ្រាប់គ្រាន់!', 'error');
                return;
                }

                try {
                await update(ref(db, `inventory_items/${item.id}`), {
                    quantity: item.quantity - qty,
                    lastUpdated: new Date().toISOString()
                });
                
                const newReqRef = push(ref(db, 'inventory_requests'));
                await set(newReqRef, {
                    type: 'DIRECT_OUT',
                    itemId: item.id,
                    itemName: item.name,
                    category: item.category,
                    quantity: qty,
                    reason: formData.reason,
                    date: new Date().toISOString(),
                    status: 'COMPLETED'
                });

                showNotification('បានដកសម្ភារៈចេញដោយជោគជ័យ!', 'success');
                resetForm();
                } catch (error) {
                showNotification('មានបញ្ហាពេលដកចេញ', 'error');
                }
            };

            const handleRequest = async (e, formData, resetForm) => {
                e.preventDefault();
                
                // 1. Find the item
                const item = items.find(i => i.id === formData.itemId);
                if (!item) {
                    showNotification('សូមជ្រើសរើសឈ្មោះសម្ភារៈ', 'error');
                    return;
                }

                const qty = parseInt(formData.quantity);

                // 2. Check Stock
                if (item.quantity < qty) {
                    showNotification(`ស្តុកមិនគ្រប់គ្រាន់! (នៅសល់: ${item.quantity})`, 'error');
                    return;
                }

                try {
                    // 3. Deduct Stock Immediately
                    await update(ref(db, `inventory_items/${item.id}`), {
                        quantity: item.quantity - qty,
                        lastUpdated: new Date().toISOString()
                    });

                    // 4. Log as Request (COMPLETED)
                    const newReqRef = push(ref(db, 'inventory_requests'));
                    await set(newReqRef, {
                        ...formData,
                        itemName: item.name, // Save name for history
                        category: item.category,
                        quantity: qty,
                        type: 'REQUEST_OUT', 
                        status: 'COMPLETED',
                        date: new Date().toISOString()
                    });
                    
                    showNotification('បានកាត់ស្តុក និងបង្កើតសំណើដោយជោគជ័យ!', 'success');
                    resetForm();
                } catch (error) {
                    console.error(error);
                    showNotification('មានបញ្ហាក្នុងការបញ្ជូនសំណើ', 'error');
                }
            };

            const handleDeleteItem = async (id, name) => {
                console.log(`CONFIRM: តើអ្នកពិតជាចង់លុប "${name}" ចេញពីស្តុកមែនទេ?`);
                if(true) { 
                try {
                    await remove(ref(db, `inventory_items/${id}`));
                    showNotification('បានលុបទិន្នន័យជោគជ័យ', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('មិនអាចលុបបានទេ', 'error');
                }
                }
            };

            const handleUpdateItem = async (e, editingItem, setEditingItem) => {
                e.preventDefault();
                try {
                await update(ref(db, `inventory_items/${editingItem.id}`), {
                    name: editingItem.name,
                    category: editingItem.category,
                    cabinetNo: editingItem.cabinetNo, 
                    quantity: parseInt(editingItem.quantity),
                    unit: editingItem.unit,
                    description: editingItem.description,
                    lastUpdated: new Date().toISOString()
                });
                showNotification('កែប្រែទិន្នន័យជោគជ័យ!', 'success');
                setEditingItem(null);
                } catch (error) {
                console.error(error);
                showNotification('បរាជ័យក្នុងការកែប្រែ', 'error');
                }
            };

            const handleDeleteHistory = async (historyItem) => {
                console.log(`CONFIRM: លុបកំណត់ត្រានេះនឹងបង្វិលចំនួន ${historyItem.quantity} ចូលស្តុកវិញ។ តើអ្នកយល់ព្រមទេ?`);
                if(!true) return; 

                try {
                let inventoryItem = items.find(i => i.id === historyItem.itemId);
                if (!inventoryItem) {
                    inventoryItem = items.find(i => i.name === historyItem.itemName);
                }

                if (inventoryItem) {
                    await update(ref(db, `inventory_items/${inventoryItem.id}`), {
                    quantity: parseInt(inventoryItem.quantity) + parseInt(historyItem.quantity),
                    lastUpdated: new Date().toISOString()
                    });
                } else {
                    console.log("ALERT: សម្ភារៈនេះប្រហែលត្រូវបានលុបពីស្តុកហើយ។ ទិន្នន័យនឹងត្រូវបានលុបចេញពីប្រវត្តិប៉ុណ្ណោះ។");
                }

                await remove(ref(db, `inventory_requests/${historyItem.id}`));
                showNotification('បានលុប និងបង្វិលស្តុកវិញជោគជ័យ', 'success');
                } catch (error) {
                console.error(error);
                showNotification('បរាជ័យក្នុងការលុបប្រវត្តិ', 'error');
                }
            };

            const handleUpdateHistory = async (e, editingHistory, setEditingHistory) => {
                e.preventDefault();
                const oldQty = parseInt(editingHistory.originalQuantity); 
                const newQty = parseInt(editingHistory.quantity);
                
                try {
                if (oldQty !== newQty) {
                    const diff = newQty - oldQty; 
                    let inventoryItem = items.find(i => i.id === editingHistory.itemId);
                    if (!inventoryItem) inventoryItem = items.find(i => i.name === editingHistory.itemName);

                    if (inventoryItem) {
                    if (inventoryItem.quantity < diff) {
                        console.log("ALERT: ស្តុកមិនគ្រប់គ្រាន់សម្រាប់ការកែប្រែចំនួននេះទេ!");
                        return;
                    }
                    await update(ref(db, `inventory_items/${inventoryItem.id}`), {
                        quantity: parseInt(inventoryItem.quantity) - diff,
                        lastUpdated: new Date().toISOString()
                    });
                    } else {
                        console.log("ALERT: រកមិនឃើញសម្ភារៈក្នុងស្តុក។ កែប្រែបានតែទិន្នន័យប្រវត្តិប៉ុណ្ណោះ។");
                    }
                }

                await update(ref(db, `inventory_requests/${editingHistory.id}`), {
                    quantity: newQty,
                    reason: editingHistory.reason,
                    requester: editingHistory.requester || ''
                });

                showNotification('កែប្រែប្រវត្តិជោគជ័យ!', 'success');
                setEditingHistory(null);
                } catch (error) {
                console.error(error);
                showNotification('បរាជ័យក្នុងការកែប្រែ', 'error');
                }
            };

            // --- Sub-Components ---
            const DashboardView = () => {
                const totalItems = items.length;
                const lowStockItems = items.filter(i => i.quantity < 5);
                const totalRequests = requests.filter(r => r.type === 'REQUEST_OUT').length;

                return (
                <div className="space-y-4 animate-fadeIn">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <Database size={20} className="text-green-600"/>
                    ផ្ទាំងគ្រប់គ្រង (Realtime DB)
                    </h2>
                    
                    <div className="grid grid-cols-2 gap-4">
                    <div className="bg-blue-600 text-white p-4 rounded-xl shadow-sm">
                        <div className="text-3xl font-bold">{totalItems}</div>
                        <div className="text-sm opacity-90">មុខទំនិញសរុប</div>
                    </div>
                    <div className="bg-purple-600 text-white p-4 rounded-xl shadow-sm">
                        <div className="text-3xl font-bold">{totalRequests}</div>
                        <div className="text-sm opacity-90">សំណើដកសរុប</div>
                    </div>
                    </div>

                    {lowStockItems.length > 0 && (
                    <div className="bg-red-50 border border-red-100 rounded-xl p-4 mt-4">
                        <div className="flex items-center gap-2 text-red-700 font-bold mb-2">
                        <AlertTriangle size={20} />
                        <h3>សម្ភារៈជិតអស់ពីស្តុក ({lowStockItems.length})</h3>
                        </div>
                        <ul className="space-y-2">
                        {lowStockItems.map(item => (
                            <li key={item.id} className="flex justify-between items-center bg-white p-2 rounded border border-red-100 text-sm">
                            <span>{item.name}</span>
                            <span className="font-bold text-red-600">សល់: {item.quantity}</span>
                            </li>
                        ))}
                        </ul>
                    </div>
                    )}
                </div>
                );
            };

            const HistoryView = () => {
                const [historyTab, setHistoryTab] = useState('direct'); 
                const [editingHistory, setEditingHistory] = useState(null);
                const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);

                const historyItems = requests.filter(r => 
                    historyTab === 'direct' ? r.type === 'DIRECT_OUT' : r.type === 'REQUEST_OUT'
                );

                const formatDate = (isoString) => {
                    if (!isoString) return 'N/A';
                    const date = new Date(isoString);
                    return date.toLocaleDateString('km-KH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' });
                };

                // Export to Excel Function
                const exportToExcel = () => {
                    if (historyItems.length === 0) {
                        alert("គ្មានទិន្នន័យសម្រាប់ Export ទេ");
                        return;
                    }
                    
                    const dataToExport = historyItems.map(item => ({
                        'កាលបរិច្ឆេទ': formatDate(item.date),
                        'ប្រភេទប្រតិបត្តិការ': item.type === 'REQUEST_OUT' ? 'សំណើដក' : 'ដកចេញទូទៅ',
                        'ឈ្មោះសម្ភារៈ': item.itemName,
                        'ប្រភេទសម្ភារៈ': item.category,
                        'ចំនួន': item.quantity,
                        'អ្នកស្នើសុំ': item.requester || '-',
                        'មូលហេតុ': item.reason
                    }));

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    XLSX.utils.book_append_sheet(wb, ws, "History");
                    XLSX.writeFile(wb, `Inventory_History_${new Date().toISOString().slice(0,10)}.xlsx`);
                };

                // DIRECT PDF DOWNLOAD Function (using html2pdf.js)
                const downloadPDF = () => {
                    if (historyItems.length === 0) {
                        alert("គ្មានទិន្នន័យសម្រាប់ Export ទេ");
                        return;
                    }
                    
                    setIsGeneratingPDF(true);
                    showNotification("កំពុងបង្កើត PDF...", "info");

                    const tableRows = historyItems.map((item, index) => `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; text-align: center;">${index + 1}</td>
                            <td style="padding: 12px;">${formatDate(item.date)}</td>
                            <td style="padding: 12px;">
                                <div style="font-weight: bold; color: #1f2937;">${item.itemName}</div>
                                <div style="font-size: 10px; color: #6b7280;">${item.category}</div>
                            </td>
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: ${item.type === 'REQUEST_OUT' ? '#7e22ce' : '#c2410c'};">
                                -${item.quantity}
                            </td>
                            <td style="padding: 12px;">
                                <div style="font-weight: 500;">${item.requester || '-'}</div>
                            </td>
                            <td style="padding: 12px; color: #4b5563;">${item.reason}</td>
                        </tr>
                    `).join('');

                    const totalQty = historyItems.reduce((acc, item) => acc + parseInt(item.quantity), 0);
                    
                    // Construct the HTML structure for the PDF (Hidden from view, rendered for PDF)
                    const element = document.createElement('div');
                    element.innerHTML = `
                        <div style="font-family: 'Kantumruy Pro', sans-serif; color: #1f2937; padding: 20px; background: white; width: 100%;">
                            <style>
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 20px; }
                                .logo-text { font-size: 24px; font-weight: 700; color: #1d4ed8; text-transform: uppercase; letter-spacing: 1px; }
                                .sub-header { font-size: 14px; color: #6b7280; margin-top: 5px; }
                                .report-title { text-align: center; font-size: 18px; font-weight: bold; margin: 20px 0; color: #111827; }
                                table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
                                th { background-color: #f8fafc; color: #4b5563; font-weight: 600; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
                                .summary-box { margin-top: 30px; display: flex; justify-content: flex-end; }
                                .summary-table { width: auto; }
                                .summary-table td { padding: 5px 20px; font-size: 14px; }
                                .signatures { margin-top: 60px; display: flex; justify-content: space-between; padding: 0 20px; }
                                .sig-block { text-align: center; width: 200px; }
                                .sig-line { border-top: 1px solid #9ca3af; margin-top: 50px; padding-top: 10px; font-size: 12px; font-weight: bold; }
                            </style>

                            <div class="header">
                                <div class="logo-text">IT Inventory Management</div>
                                <div class="sub-header">ប្រព័ន្ធគ្រប់គ្រងស្តុកសម្ភារៈបច្ចេកវិទ្យា</div>
                                <div style="font-size: 10px; color: #9ca3af; margin-top: 5px;">Generated on: ${new Date().toLocaleString('km-KH')}</div>
                            </div>

                            <div class="report-title">
                                របាយការណ៍ស្តុក (${historyTab === 'direct' ? 'ដកចេញទូទៅ' : 'សំណើដក'})
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 50px; text-align: center;">ល.រ</th>
                                        <th style="width: 120px;">កាលបរិច្ឆេទ</th>
                                        <th>ឈ្មោះសម្ភារៈ / ប្រភេទ</th>
                                        <th style="width: 80px; text-align: center;">ចំនួន</th>
                                        <th>អ្នកស្នើសុំ</th>
                                        <th>មូលហេតុ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>

                            <div class="summary-box">
                                <table class="summary-table">
                                    <tr>
                                        <td style="text-align: right; color: #6b7280;">ចំនួនប្រតិបត្តិការសរុប:</td>
                                        <td style="font-weight: bold;">${historyItems.length}</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: right; color: #6b7280;">បរិមាណដកសរុប:</td>
                                        <td style="font-weight: bold; color: #ef4444;">${totalQty} PCS</td>
                                    </tr>
                                </table>
                            </div>

                            <div class="signatures">
                                <div class="sig-block">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">រៀបចំដោយ</div>
                                    <div class="sig-line">ហត្ថលេខា & ឈ្មោះ</div>
                                </div>
                                <div class="sig-block">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">ត្រួតពិនិត្យដោយ</div>
                                    <div class="sig-line">ហត្ថលេខា & ឈ្មោះ</div>
                                </div>
                            </div>
                        </div>
                    `;

                    const opt = {
                        margin: 10,
                        filename: `Inventory_Report_${new Date().toISOString().slice(0,10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    // Execute PDF generation
                    window.html2pdf().set(opt).from(element).save().then(() => {
                        setIsGeneratingPDF(false);
                        showNotification("បានទាញយក PDF ជោគជ័យ!", "success");
                    });
                };

                return (
                <div className="animate-fadeIn relative">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <History size={20} className="text-orange-600"/>
                        ប្រវត្តិប្រតិបត្តិការ
                    </h2>

                    <div className="flex gap-2 mb-4">
                        <div className="flex-1 flex bg-gray-100 rounded-lg p-1">
                            <button 
                                onClick={() => setHistoryTab('direct')}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2 ${historyTab === 'direct' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'}`}
                            >
                                <PackageMinus size={16}/> ដកចេញទូទៅ
                            </button>
                            <button 
                                onClick={() => setHistoryTab('request')}
                                className={`flex-1 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2 ${historyTab === 'request' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500'}`}
                            >
                                <ClipboardList size={16}/> ប្រវត្តិសំណើ
                            </button>
                        </div>
                    </div>

                    {/* Export Buttons */}
                    <div className="flex gap-2 mb-4 justify-end">
                        <button 
                            onClick={exportToExcel}
                            className="flex items-center gap-1 bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700 transition-colors shadow-sm"
                        >
                            <FileSpreadsheet size={14} /> Excel
                        </button>
                        <button 
                            onClick={downloadPDF}
                            disabled={isGeneratingPDF}
                            className="flex items-center gap-1 bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-700 transition-colors shadow-sm disabled:bg-red-300"
                        >
                            {isGeneratingPDF ? (
                                <span className="animate-spin mr-1">⏳</span>
                            ) : (
                                <Download size={14} />
                            )}
                            {isGeneratingPDF ? 'Creating...' : 'Download PDF'}
                        </button>
                    </div>

                    <div className="space-y-3 pb-20">
                    {historyItems.map(item => (
                        <div key={item.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <div className="flex justify-between items-start mb-2">
                            <div className="flex items-start gap-3">
                            <div className={`p-2 rounded-lg mt-1 ${item.type === 'REQUEST_OUT' ? 'bg-purple-50 text-purple-600' : 'bg-orange-50 text-orange-600'}`}>
                                {item.type === 'REQUEST_OUT' ? <ClipboardList size={20}/> : <PackageMinus size={20} />}
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-800">{item.itemName}</h3>
                                <div className="flex items-center gap-1 text-xs text-gray-500 mt-1">
                                <Calendar size={12} />
                                <span>{formatDate(item.date)}</span>
                                </div>
                                {item.requester && (
                                    <div className="flex items-center gap-1 text-xs text-blue-600 font-medium mt-1 bg-blue-50 px-1 rounded w-fit">
                                        <User size={12} />
                                        <span>{item.requester}</span>
                                    </div>
                                )}
                            </div>
                            </div>
                            <div className="text-right">
                            <span className="font-bold text-red-600 text-lg">-{item.quantity}</span>
                            <p className="text-xs text-gray-400">PCS</p>
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-center mt-2 pl-14">
                            <p className="text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                            {item.reason}
                            </p>
                            <div className="flex gap-2">
                            <button 
                                onClick={() => setEditingHistory({...item, originalQuantity: item.quantity})} 
                                className="text-blue-500 hover:bg-blue-50 p-1.5 rounded"
                            >
                                <Edit size={16} />
                            </button>
                            <button 
                                onClick={() => handleDeleteHistory(item)} 
                                className="text-red-500 hover:bg-red-50 p-1.5 rounded"
                            >
                                <Trash2 size={16} />
                            </button>
                            </div>
                        </div>
                        </div>
                    ))}

                    {historyItems.length === 0 && (
                        <div className="text-center py-10 text-gray-500 flex flex-col items-center">
                        <div className="bg-gray-100 p-4 rounded-full mb-3">
                            <History size={30} className="text-gray-400"/>
                        </div>
                        <p>មិនទាន់មានប្រវត្តិសម្រាប់ផ្នែកនេះទេ</p>
                        </div>
                    )}
                    </div>

                    {editingHistory && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-fadeIn">
                        <div className="bg-blue-600 p-4 flex justify-between items-center text-white">
                            <h3 className="font-bold text-lg flex items-center gap-2"><Edit size={20}/> កែប្រែប្រវត្តិ</h3>
                            <button onClick={() => setEditingHistory(null)} className="hover:bg-blue-700 p-1 rounded"><X size={20}/></button>
                        </div>
                        
                        <div className="p-5">
                            <form onSubmit={(e) => handleUpdateHistory(e, editingHistory, setEditingHistory)}>
                            <div className="mb-4 bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-200">
                                ចំណាំ: ការកែប្រែ "ចំនួន" នឹងធ្វើឱ្យមានការកែតម្រូវស្តុកដោយស្វ័យប្រវត្តិ។
                            </div>
                            <Input 
                                label="ឈ្មោះសម្ភារៈ (មិនអាចកែ)" 
                                value={editingHistory.itemName} 
                                disabled={true}
                                onChange={() => {}}
                            />
                            {editingHistory.type === 'REQUEST_OUT' && (
                                <Input 
                                    label="ឈ្មោះអ្នកស្នើសុំ" 
                                    required 
                                    value={editingHistory.requester} 
                                    onChange={e => setEditingHistory({...editingHistory, requester: e.target.value})} 
                                />
                            )}
                            <Input 
                                label="ចំនួនដកចេញ" 
                                type="number" 
                                required 
                                value={editingHistory.quantity} 
                                onChange={e => setEditingHistory({...editingHistory, quantity: e.target.value})} 
                            />
                            <Input 
                                label="មូលហេតុ" 
                                required 
                                value={editingHistory.reason} 
                                onChange={e => setEditingHistory({...editingHistory, reason: e.target.value})} 
                            />
                            
                            <div className="flex gap-3 mt-6">
                                <Button onClick={() => setEditingHistory(null)} variant="secondary" className="flex-1">បោះបង់</Button>
                                <Button type="submit" variant="success" className="flex-1">រក្សាទុក</Button>
                            </div>
                            </form>
                        </div>
                        </div>
                    </div>
                    )}
                </div>
                );
            };

            const InventoryView = () => {
                const [editingItem, setEditingItem] = useState(null);

                const filteredItems = items.filter(item => 
                item.name?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                item.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.cabinetNo?.toLowerCase().includes(searchTerm.toLowerCase()) 
                );

                return (
                <div className="animate-fadeIn relative">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">បញ្ជីសម្ភារៈក្នុងស្តុក</h2>
                    
                    <div className="relative mb-4">
                    <Search className="absolute left-3 top-2.5 text-gray-400" size={20} />
                    <input
                        type="text"
                        placeholder="ស្វែងរកឈ្មោះ ប្រភេទ ឬ លេខទូ..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    </div>

                    <div className="space-y-3 pb-20">
                    {filteredItems.map(item => (
                        <div key={item.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <h3 className="font-bold text-gray-800">{item.name}</h3>
                                    <p className="text-xs text-gray-500">{item.category} • {item.description || 'គ្មានការបរិយាយ'}</p>
                                </div>
                                <div className="text-right">
                                    <div className={`text-sm font-bold px-2 py-1 rounded-full mr-2 ${item.quantity < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                        {item.quantity} {item.unit || 'pcs'}
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">
                                        {item.cabinetNo ? `(${item.cabinetNo.replace('Cabinet ', 'ទូទី')})` : ''} 
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex justify-end items-center gap-2 border-t pt-2 mt-2">
                                <button 
                                onClick={() => setEditingItem(item)}
                                className="bg-gray-100 text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition-colors"
                                >
                                <Edit size={18} />
                                </button>

                                <button 
                                onClick={() => handleDeleteItem(item.id, item.name)} 
                                className="bg-gray-100 text-red-500 p-2 rounded-lg hover:bg-red-50 transition-colors"
                                >
                                <Trash2 size={18} />
                                </button>
                            </div>
                        </div>
                    ))}
                    {filteredItems.length === 0 && (
                        <div className="text-center py-10 text-gray-500">
                        រកមិនឃើញទិន្នន័យក្នុង Realtime DB
                        </div>
                    )}
                    </div>

                    {editingItem && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-fadeIn">
                        <div className="bg-blue-600 p-4 flex justify-between items-center text-white">
                            <h3 className="font-bold text-lg flex items-center gap-2"><Edit size={20}/> កែប្រែទិន្នន័យ</h3>
                            <button onClick={() => setEditingItem(null)} className="hover:bg-blue-700 p-1 rounded"><X size={20}/></button>
                        </div>
                        
                        <div className="p-5">
                            <form onSubmit={(e) => handleUpdateItem(e, editingItem, setEditingItem)}>
                            <Input 
                                label="ឈ្មោះសម្ភារៈ" 
                                required 
                                value={editingItem.name} 
                                onChange={e => setEditingItem({...editingItem, name: e.target.value})} 
                            />
                            <div className="grid grid-cols-2 gap-3">
                                <Select 
                                label="ប្រភេទ" 
                                value={editingItem.category} 
                                onChange={e => setEditingItem({...editingItem, category: e.target.value})}
                                options={[
                                    {label: "Computer", value: "Computer"},
                                    {label: "Accessory", value: "Accessory"},
                                    {label: "Network", value: "Network"},
                                    {label: "Printer", value: "Printer"},
                                    {label: "Other", value: "Other"}
                                ]}
                                />
                                <Select 
                                    label="លេខទូ" 
                                    value={editingItem.cabinetNo} 
                                    onChange={e => setEditingItem({...editingItem, cabinetNo: e.target.value})}
                                    options={CABINET_OPTIONS}
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <Input 
                                    label="ចំនួន" 
                                    type="number" 
                                    required 
                                    value={editingItem.quantity} 
                                    onChange={e => setEditingItem({...editingItem, quantity: e.target.value})} 
                                />
                                <Input 
                                    label="ខ្នាត (Unit)" 
                                    value={editingItem.unit} 
                                    onChange={e => setEditingItem({...editingItem, unit: e.target.value})} 
                                />
                            </div>
                            <Input 
                                label="បរិយាយ (ផ្សេងៗ)" 
                                value={editingItem.description} 
                                onChange={e => setEditingItem({...editingItem, description: e.target.value})} 
                            />
                            
                            <div className="flex gap-3 mt-6">
                                <Button onClick={() => setEditingItem(null)} variant="secondary" className="flex-1">បោះបង់</Button>
                                <Button type="submit" variant="success" className="flex-1">រក្សាទុក</Button>
                            </div>
                            </form>
                        </div>
                        </div>
                    </div>
                    )}
                </div>
                );
            };

            const OperationsView = () => {
                const [mode, setMode] = useState('in');
                const [formData, setFormData] = useState({
                    name: '', category: '', quantity: '', unit: '', description: '', cabinetNo: '',
                    itemId: '', reason: '', requester: '', itemName: ''
                });
                
                const [personnel, setPersonnel] = useState([]);
                const [personSearch, setPersonSearch] = useState('');
                const [showDropdown, setShowDropdown] = useState(false);
                const [selectedPerson, setSelectedPerson] = useState(null);

                useEffect(() => {
                    const initUserAppAuth = async () => {
                        try {
                            await signInAnonymously(userAuth);
                        } catch (e) {
                             console.log("User List App: Public Mode (Auth skipped or failed - check console for details if needed)");
                        }
                    };
                    initUserAppAuth();

                    const usersRef = ref(userDb, 'students'); 
                    
                    onValue(usersRef, (snapshot) => {
                        const data = snapshot.val();
                        const loadedPeople = [];
                        if (data) {
                            if (Array.isArray(data)) {
                                loadedPeople.push(...data.filter(p => p)); 
                            } else {
                                for (const key in data) {
                                    loadedPeople.push({ id_key: key, ...data[key] });
                                }
                            }
                        }
                        setPersonnel(loadedPeople);
                    }, (error) => {
                        console.error("User DB Error:", error);
                    });
                }, []);

                const filteredPersonnel = personnel.filter(p => {
                    if (!personSearch) return false;
                    const searchLower = personSearch.toLowerCase();
                    const name = p.Name || p.name || p['ឈ្មោះ'] || '';
                    const id = p.ID || p.id || p['អត្តលេខ'] || '';
                    return name.toString().toLowerCase().includes(searchLower) || 
                           id.toString().toLowerCase().includes(searchLower);
                });

                const handleSelectPerson = (person) => {
                    setSelectedPerson(person);
                    const name = person.Name || person.name || person['ឈ្មោះ'];
                    const id = person.ID || person.id || person['អត្តលេខ'];
                    setFormData(prev => ({ ...prev, requester: `${name} (${id})` }));
                    setPersonSearch(`${name} (${id})`);
                    setShowDropdown(false);
                };

                const resetForm = () => {
                    setFormData({
                        name: '', category: '', quantity: '', unit: '', description: '', cabinetNo: '',
                        itemId: '', reason: '', requester: '', itemName: ''
                    });
                    setSelectedPerson(null);
                    setPersonSearch('');
                };

                return (
                <div className="animate-fadeIn pb-20">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">ប្រតិបត្តិការ</h2>
                    
                    <div className="flex gap-2 mb-6 p-1 bg-gray-100 rounded-lg">
                    <button 
                        onClick={() => { setMode('in'); resetForm(); }}
                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'in' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}
                    >
                        បញ្ចូលស្តុក
                    </button>
                    <button 
                        onClick={() => { setMode('out'); resetForm(); }}
                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'out' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'}`}
                    >
                        ដកចេញ
                    </button>
                    <button 
                        onClick={() => { setMode('request'); resetForm(); }}
                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'request' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500'}`}
                    >
                        សំណើ
                    </button>
                    </div>

                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    {mode === 'in' && (
                        <form onSubmit={(e) => handleAddItem(e, formData, resetForm)}>
                        <h3 className="text-lg font-bold text-blue-700 mb-4 flex items-center gap-2">
                            <PackagePlus size={20}/> បញ្ចូលទិន្នន័យថ្មី
                        </h3>
                        <Input label="ឈ្មោះសម្ភារៈ" required value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <Select 
                            label="ប្រភេទ" 
                            value={formData.category} 
                            onChange={e => setFormData({...formData, category: e.target.value})}
                            options={[
                                {label: "Computer", value: "Computer"},
                                {label: "Accessory", value: "Accessory"},
                                {label: "Network", value: "Network"},
                                {label: "Printer", value: "Printer"},
                                {label: "Other", value: "Other"}
                            ]}
                            />
                            <Select 
                                label="លេខទូ" 
                                required
                                value={formData.cabinetNo} 
                                onChange={e => setFormData({...formData, cabinetNo: e.target.value})}
                                options={CABINET_OPTIONS}
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="ចំនួន" type="number" required value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} />
                            <Input label="ខ្នាត (Unit)" placeholder="PCS, Set, Box..." value={formData.unit} onChange={e => setFormData({...formData, unit: e.target.value})} />
                        </div>
                        <Input label="ផ្សេងៗ" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                        
                        <Button type="submit" variant="primary" className="w-full mt-4">រក្សាទុក</Button>
                        </form>
                    )}

                    {mode === 'out' && (
                        <form onSubmit={(e) => handleStockOut(e, formData, resetForm)}>
                        <h3 className="text-lg font-bold text-orange-600 mb-4 flex items-center gap-2">
                            <PackageMinus size={20}/> ដកសម្ភារៈចេញ
                        </h3>
                        <Select 
                            label="ជ្រើសរើសសម្ភារៈ" 
                            required
                            value={formData.itemId} 
                            onChange={e => setFormData({...formData, itemId: e.target.value})}
                            options={items.map(i => ({ label: `${i.name} (សល់: ${i.quantity})`, value: i.id }))}
                        />
                        <Input label="ចំនួនដក" type="number" required value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} />
                        <Input label="មូលហេតុ/យកទៅណា" required value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} />
                        
                        <Button type="submit" className="w-full mt-4 bg-orange-600 hover:bg-orange-700">កាត់ស្តុក</Button>
                        </form>
                    )}

                    {mode === 'request' && (
                        <form onSubmit={(e) => handleRequest(e, formData, resetForm)}>
                        <h3 className="text-lg font-bold text-purple-600 mb-4 flex items-center gap-2">
                            <ClipboardList size={20}/> បញ្ចូលទិន្នន័យសំណើ
                        </h3>
                        
                        {/* --- Requester Search Box --- */}
                        <div className="mb-4 relative">
                            <label className="block text-sm font-medium text-gray-700 mb-1">ឈ្មោះអ្នកស្នើសុំ (ស្វែងរកតាម ឈ្មោះ/អត្តលេខ)</label>
                            <div className="relative">
                                <input
                                    type="text"
                                    value={personSearch}
                                    onChange={(e) => {
                                        setPersonSearch(e.target.value);
                                        setShowDropdown(true);
                                        if(e.target.value === '') setSelectedPerson(null);
                                    }}
                                    onFocus={() => setShowDropdown(true)}
                                    placeholder="វាយឈ្មោះ ឬ អត្តលេខ..."
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none pl-10"
                                    required
                                />
                                <Search className="absolute left-3 top-2.5 text-gray-400" size={18} />
                                {personSearch && (
                                    <button 
                                        type="button" 
                                        onClick={() => {setPersonSearch(''); setSelectedPerson(null); setFormData(p=>({...p, requester: ''}))}}
                                        className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"
                                    >
                                        <X size={18}/>
                                    </button>
                                )}
                            </div>

                            {/* Search Dropdown */}
                            {showDropdown && personSearch && filteredPersonnel.length > 0 && (
                                <div className="absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto custom-scrollbar">
                                    {filteredPersonnel.map((person, idx) => {
                                        const pName = person.Name || person.name || person['ឈ្មោះ'] || 'N/A';
                                        const pId = person.ID || person.id || person['អត្តលេខ'] || 'N/A';
                                        const pImg = person.Photo || person.photo || person['រូបថត'];

                                        return (
                                            <div 
                                                key={idx} 
                                                onClick={() => handleSelectPerson(person)}
                                                className="p-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-0 flex items-center gap-3"
                                            >
                                                <div className="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                                    {pImg ? (
                                                        <img src={pImg} alt="Avatar" className="w-full h-full object-cover"/>
                                                    ) : (
                                                        <User className="w-full h-full p-1 text-gray-400"/>
                                                    )}
                                                </div>
                                                <div>
                                                    <div className="font-bold text-sm text-gray-800">{pName}</div>
                                                    <div className="text-xs text-gray-500">ID: {pId}</div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {/* --- Selected Person Card Info --- */}
                        {selectedPerson && (
                            <div className="bg-purple-50 border border-purple-100 rounded-lg p-4 mb-4 flex gap-4 items-start animate-fadeIn">
                                <div className="w-16 h-16 rounded-full bg-gray-200 overflow-hidden shadow-sm flex-shrink-0 border-2 border-white">
                                    {(selectedPerson.Photo || selectedPerson.photo || selectedPerson['រូបថត']) ? (
                                        <img src={selectedPerson.Photo || selectedPerson.photo || selectedPerson['រូបថត']} alt="Profile" className="w-full h-full object-cover"/>
                                    ) : (
                                        <User className="w-full h-full p-3 text-gray-400"/>
                                    )}
                                </div>
                                <div className="flex-1 space-y-1">
                                    <h4 className="font-bold text-purple-900 text-lg">{selectedPerson.Name || selectedPerson.name || selectedPerson['ឈ្មោះ']}</h4>
                                    
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                                        <div className="flex items-center gap-1 text-gray-600">
                                            <CreditCard size={12}/>
                                            <span>ID: <b>{selectedPerson.ID || selectedPerson.id || selectedPerson['អត្តលេខ']}</b></span>
                                        </div>
                                        <div className="flex items-center gap-1 text-gray-600">
                                            <Briefcase size={12}/>
                                            <span>ថ្នាក់: <b>{selectedPerson.Rank || selectedPerson.rank || selectedPerson['ថ្នាក់'] || '-'}</b></span>
                                        </div>
                                        <div className="flex items-center gap-1 text-gray-600">
                                            <Users size={12}/>
                                            <span>ក្រុម: <b>{selectedPerson.Group || selectedPerson.group || selectedPerson['ក្រុម'] || '-'}</b></span>
                                        </div>
                                        <div className="flex items-center gap-1 text-gray-600">
                                            <LayoutDashboard size={12}/>
                                            <span>ផ្នែក: <b>{selectedPerson.Section || selectedPerson.section || selectedPerson['ផ្នែកការងារ'] || '-'}</b></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <Select 
                            label="ឈ្មោះសម្ភារៈ" 
                            required
                            value={formData.itemId} 
                            onChange={e => setFormData({...formData, itemId: e.target.value})}
                            options={items.map(i => ({ label: `${i.name} (សល់: ${i.quantity})`, value: i.id }))}
                        />
                        <Input label="ចំនួនស្នើសុំ" type="number" required value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} />
                        <Input label="មូលហេតុ" required value={formData.reason} onChange={e => setFormData({...formData, reason: e.target.value})} />
                        
                        <Button type="submit" className="w-full mt-4 bg-purple-600 hover:bg-purple-700">បញ្ជូនសំណើ</Button>
                        </form>
                    )}
                    </div>
                </div>
                );
            };

            // Main Render
            if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold animate-pulse">កំពុងតភ្ជាប់ទៅ Realtime DB...</div>;

            return (
                <div className="pb-16 max-w-md mx-auto">
                    {/* Top Header */}
                    <div className="bg-white px-4 py-4 shadow-sm flex items-center justify-between sticky top-0 z-10 no-print">
                        <div className="flex items-center gap-2 text-blue-700 font-bold text-lg">
                            <Computer size={24} />
                            <span>IT Inventory</span>
                        </div>
                        <div className={`text-xs px-2 py-1 rounded font-bold flex items-center gap-1 ${authStatus === 'public' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                            {authStatus === 'public' ? (
                                <><UserX size={12}/> PUBLIC MODE</>
                            ) : (
                                <><UserCheck size={12}/> AUTH MODE</>
                            )}
                        </div>
                    </div>

                    {/* Notification Toast */}
                    {notification && (
                        <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 w-11/12 max-w-sm animate-fadeIn no-print">
                            <div className={`shadow-lg rounded-lg p-3 text-center text-white font-medium ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
                                {notification.msg}
                            </div>
                        </div>
                    )}

                    {/* Content */}
                    <main className="p-4">
                        {activeTab === 'dashboard' && <DashboardView />}
                        {activeTab === 'inventory' && <InventoryView />}
                        {activeTab === 'operations' && <OperationsView />}
                        {activeTab === 'history' && <HistoryView />}
                    </main>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 w-full bg-white border-t border-gray-200 shadow-lg flex justify-around py-2 z-40 max-w-md left-1/2 transform -translate-x-1/2 no-print">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 p-1 rounded-lg transition-colors ${activeTab === 'dashboard' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}>
                            <LayoutDashboard size={20} />
                            <span className="text-[10px] font-medium">ផ្ទាំងគ្រប់គ្រង</span>
                        </button>
                        <button onClick={() => setActiveTab('operations')} className={`flex flex-col items-center gap-1 p-1 rounded-lg transition-colors ${activeTab === 'operations' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}>
                            <Edit size={20} />
                            <span className="text-[10px] font-medium">ប្រតិបត្តិការ</span>
                        </button>
                        <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center gap-1 p-1 rounded-lg transition-colors ${activeTab === 'inventory' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}>
                            <PackagePlus size={20} />
                            <span className="text-[10px] font-medium">ស្តុក</span>
                        </button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 p-1 rounded-lg transition-colors ${activeTab === 'history' ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}`}>
                            <History size={20} />
                            <span className="text-[10px] font-medium">ប្រវត្តិ</span>
                        </button>
                    </div>
                </div>
            );
        }

        // Render the App
        const root = createRoot(document.getElementById('root'));
        root.render(<ComputerInventoryApp />);
    </script>
</body>
</html>
